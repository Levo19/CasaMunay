<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casa Munay - Bienvenida</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos espec칤ficos para Index */
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            /* M치s compacto */
            gap: 15px;
            margin-top: 20px;
        }

        .room-card {
            background: white;
            border-radius: var(--radius-m);
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow-card);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-soft);
        }

        .room-card.ocupada {
            border: 2px solid var(--primary);
            background: #F0F9FF;
        }

        .room-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-main);
        }

        .room-status {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
            color: var(--text-muted);
        }

        .room-card.ocupada .room-status {
            color: var(--primary);
            font-weight: 700;
        }

        .guest-name {
            font-size: 0.85rem;
            color: var(--secondary);
            margin-top: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <header class="header-hero" style="text-align: center; margin-bottom: 40px;">
            <div class="greeting">Bienvenido a</div>
            <div class="user-name" style="font-size: 2.5rem;">Casa Munay</div>
            <p style="color: var(--text-muted); margin-top: 10px;">Selecciona tu habitaci칩n para comenzar</p>
        </header>

        <div id="roomsContainer" class="room-grid"></div>

        <p id="errorMsg" style="text-align: center; color: #ef4444; margin-top: 20px; display: none;"></p>
    </div>

    <script>
        // 游뚿 CONFIGURACI칍N TEMPORAL (Debe coincidir con app.js)
        const API_URL = 'https://script.google.com/macros/s/AKfycbzKJ3J5cG8cJ4hKFPDmVYOfRTn9aqmkOnjyDfMabRhsNaFCO-7AQ2COPa9iGjJysMkL/exec';

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch(`${API_URL}?action=getHabitaciones`);
                const data = await res.json();

                if (data.habitaciones && data.habitaciones.length > 0) {
                    renderRooms(data.habitaciones);
                } else {
                    // MOSTRAR PROPIAMENTE EL ERROR PARA DEBUG
                    console.log('Data recibida:', data);
                    const debugInfo = JSON.stringify(data);
                    showError(`No se encontraron habitaciones activas. (Respuesta del servidor: ${debugInfo})`);
                }
            } catch (e) {
                console.error(e);
                showError(`Error de conexi칩n: ${e.message}`);
            } finally {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
            }
        });

        function renderRooms(list) {
            const container = document.getElementById('roomsContainer');
            container.innerHTML = '';

            list.forEach(h => {
                const div = document.createElement('div');
                const isOccupied = h.estado === 'ocupada';
                div.className = `room-card ${isOccupied ? 'ocupada' : ''}`;
                div.onclick = () => {
                    sessionStorage.setItem('habitacionSeleccionada', JSON.stringify(h));
                    // Usamos 'q' (c칩digo seguro) en lugar de 'room' (n칰mero)
                    // El backend ahora devuelve 'token' en getHabitaciones
                    window.location.href = `services.html?q=${h.token || h.numero}`;
                };

                div.innerHTML = `
                    <div class="room-number">${h.numero}</div>
                    <div class="room-status">${isOccupied ? 'Ocupada' : 'Disponible'}</div>
                    ${h.huesped ? `<div class="guest-name">${h.huesped}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.innerText = msg;
            el.style.display = 'block';
        }
    </script>
</body>

</html>
